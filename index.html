<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheelio Dashboard</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- Basic Setup & Theming --- */
        :root {
            --bg-color: #1a1a2e;
            --card-bg-color: #16213e;
            --text-color: #e0e0e0;
            --primary-color: #0f3460;
            --accent-color: #e94560;
            --active-glow: #52cffe;
            --warning-glow: #e94560;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        /* --- Main Layout --- */
        .dashboard-container {
            width: 100%;
            max-width: 1200px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 .fa-dharmachakra {
            color: var(--active-glow);
            animation: gentle-spin 20s linear infinite;
            font-size: 1.2em;
        }

        @keyframes gentle-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #last-updated {
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- Card Styling --- */
        .card {
            background-color: var(--card-bg-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            margin: 0 0 20px 0;
            text-align: center;
            color: white;
        }

        /* --- Actuator Component Styling --- */
        .actuators-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }

        .actuator-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .actuator-item .icon {
            font-size: 2.5em;
            color: #4a5578;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        .actuator-item.active .icon-buzzer { color: var(--warning-glow); text-shadow: 0 0 15px var(--warning-glow); }
        .actuator-item.active .icon-warning { color: var(--warning-glow); text-shadow: 0 0 15px var(--warning-glow); }
        .actuator-item.active .icon-fog { color: var(--active-glow); text-shadow: 0 0 15px var(--active-glow); }
        
        .actuator-item span {
            font-weight: 500;
        }

        /* --- Sensor Value Component Styling --- */
        .sensor-value {
            font-size: 2.8em;
            font-weight: 700;
            text-align: center;
            margin: auto 0;
            color: white;
        }
        .sensor-value .unit {
            font-size: 0.5em;
            font-weight: 400;
            color: var(--text-color);
        }

        /* --- Inclination (Tilt) Component Styling --- */
        .tilt-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .bicycle-visualizer {
            width: 150px;
            height: 150px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, var(--bg-color) 0%, var(--card-bg-color) 100%);
            position: relative;
            overflow: hidden;
        }

        .bike-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            /* Convert black bike to match our active-glow color (#52cffe) */
            filter: 
                invert(1) /* Invert black to white */
                sepia(1) /* Add sepia for color manipulation */
                saturate(3) /* Increase saturation */
                hue-rotate(190deg) /* Rotate hue to cyan-blue range */
                brightness(1.1) /* Brighten to match our theme */
                contrast(1.3) /* Add contrast for clarity */
                drop-shadow(0 0 15px var(--active-glow)); /* Glowing effect */
            z-index: 2;
            position: relative;
        }

        .reference-line {
            position: absolute;
            background-color: var(--active-glow);
            opacity: 0.6;
            z-index: 1;
        }

        .horizontal-line {
            width: 120px;
            height: 2px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .vertical-line {
            width: 2px;
            height: 120px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Tilt Container for External Labels */
        .tilt-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
        }

        /* Direction Labels */
        .direction-label {
            font-size: 0.8em;
            font-weight: bold;
            color: var(--active-glow);
            opacity: 0.8;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
        }

        /* Roll (Side Tilt) Labels - Left and Right of circle */
        .left-label, .right-label {
            display: flex;
            align-items: center;
            min-width: 35px;
            justify-content: center;
        }

        /* Pitch (Front/Back Tilt) Labels - Left (BACK) and Right (FRONT) of circle */
        .back-label, .front-label {
            display: flex;
            align-items: center;
            min-width: 40px;
            justify-content: center;
        }

        .tilt-value {
            font-size: 1.5em;
            font-weight: 600;
        }

        /* Legacy tilt visualizer styles (keeping for compatibility) */
        .tilt-visualizer {
            width: 150px;
            height: 150px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, var(--bg-color) 0%, var(--card-bg-color) 100%);
        }

        .tilt-indicator {
            width: 90%;
            height: 5px;
            background-color: var(--active-glow);
            border-radius: 5px;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 10px var(--active-glow);
        }

        /* --- Warning Message Styling --- */
        #warning-card {
            grid-column: 1 / -1; /* Span full width */
            border-color: transparent;
            background-color: transparent;
            text-align: center;
            min-height: 50px;
            justify-content: center;
        }
        
        #warning-card.has-warning {
             background-color: #5d1c28;
             border-color: var(--accent-color);
        }

        #warning-message {
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        #warning-message i {
            margin-right: 10px;
        }

        #warning-message .fa-check-circle {
            color: #52cffe;
        }

        #warning-message .fa-exclamation-triangle {
            color: var(--accent-color);
        }

        /* --- Demo Button Styling --- */
        .demo-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: var(--active-glow);
            border: 1px solid var(--active-glow);
            border-radius: 25px;
            padding: 8px 16px;
            text-decoration: none;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .demo-button:hover {
            background-color: var(--active-glow);
            color: var(--bg-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 207, 254, 0.3);
        }

        .demo-button i {
            font-size: 0.9em;
        }

        /* --- Settings Button Styling --- */
        .settings-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--primary-color);
            color: var(--active-glow);
            border: 1px solid var(--active-glow);
            border-radius: 25px;
            padding: 8px 16px;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .settings-button:hover {
            background-color: var(--active-glow);
            color: var(--bg-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 207, 254, 0.3);
        }

        /* --- Settings Modal Styling --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg-color);
            margin: 2% auto;
            padding: 30px;
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--primary-color);
        }

        .modal-header h2 {
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close {
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--accent-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .settings-section {
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--primary-color);
        }

        .settings-section h3 {
            margin: 0 0 15px 0;
            color: var(--active-glow);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9em;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--card-bg-color);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            color: white;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--active-glow);
            box-shadow: 0 0 5px rgba(82, 207, 254, 0.3);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--primary-color);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--active-glow);
            color: var(--bg-color);
        }

        .btn-primary:hover {
            background-color: #3fb8e8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: var(--card-bg-color);
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background-color: rgba(82, 207, 254, 0.2);
            color: var(--active-glow);
            border: 1px solid var(--active-glow);
        }

        .status-error {
            background-color: rgba(233, 69, 96, 0.2);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        /* --- Toast Notification Styling --- */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: var(--card-bg-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--active-glow);
            min-width: 250px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--accent-color);
        }

        .toast i {
            font-size: 1.2em;
        }

        .toast.success i {
            color: var(--active-glow);
        }

        .toast.error i {
            color: var(--accent-color);
        }

    </style>
</head>
<body>

    <!-- Settings Button -->
    <button class="settings-button" onclick="openSettingsModal()" title="Open Settings">
        <i class="fas fa-cog"></i>
        Settings
    </button>

    <!-- Demo Button -->
    <a href="Test-Dashboard.html" class="demo-button" title="Open Test Dashboard for Demo">
        <i class="fas fa-play-circle"></i>
        Demo
    </a>

    <div class="dashboard-container">
        <header>
            <h1><i class="fas fa-dharmachakra"></i> Wheelio Dashboard</h1>
            <p id="last-updated">Connecting to Firebase...</p>
        </header>

        <div class="grid-container">
            <!-- Actuators Card -->
            <div class="card">
                <h3 class="card-title">Actuator Status</h3>
                <div class="actuators-container">
                    <div id="buzzer-status" class="actuator-item">
                        <i class="fas fa-bell icon icon-buzzer"></i>
                        <span>Buzzer</span>
                    </div>
                    <div id="warning-light-status" class="actuator-item">
                        <i class="fas fa-lightbulb icon icon-warning"></i>
                        <span>Warning Light</span>
                    </div>
                    <div id="fog-light-status" class="actuator-item">
                        <i class="fas fa-cloud-sun icon icon-fog"></i>
                        <span>Fog Light</span>
                    </div>
                </div>
            </div>

            <!-- Side to Side Tilt (Roll) -->
            <div class="card">
                <h3 class="card-title">Side Tilt (Roll)</h3>
                <div class="tilt-display">
                    <div class="tilt-container">
                        <div class="direction-label left-label">LEFT</div>
                        <div class="bicycle-visualizer">
                            <div class="reference-line vertical-line"></div>
                            <img id="roll-bicycle" src="assets/images/bike-front.png" alt="Bike Front View" class="bike-image">
                        </div>
                        <div class="direction-label right-label">RIGHT</div>
                    </div>
                    <div id="roll-value" class="tilt-value">0.00°</div>
                </div>
            </div>

            <!-- Front/Back Tilt (Pitch) -->
            <div class="card">
                <h3 class="card-title">Front/Back Tilt (Pitch)</h3>
                <div class="tilt-display">
                    <div class="tilt-container">
                        <div class="direction-label back-label">BACK</div>
                        <div class="bicycle-visualizer">
                            <div class="reference-line horizontal-line"></div>
                            <img id="pitch-bicycle" src="assets/images/bike-side.png" alt="Bike Side View" class="bike-image">
                        </div>
                        <div class="direction-label front-label">FRONT</div>
                    </div>
                    <div id="pitch-value" class="tilt-value">0.00°</div>
                </div>
            </div>
            
            <!-- Other Sensors -->
            <div class="card">
                <h3 class="card-title">Lidar Distance</h3>
                <p id="lidar-value" class="sensor-value">0.00 <span class="unit">m</span></p>
            </div>

            <div class="card">
                <h3 class="card-title">Ambient Light</h3>
                <p id="light-value" class="sensor-value">0 <span class="unit">lux</span></p>
            </div>

            <div class="card">
                <h3 class="card-title">Acceleration (X)</h3>
                <p id="accel-value" class="sensor-value">0.00 <span class="unit">m/s²</span></p>
            </div>
            
            <!-- Warning Message -->
            <div id="warning-card" class="card">
                <p id="warning-message"><i class="fas fa-check-circle"></i> System nominal.</p>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Wheelio Settings</h2>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            
            <div class="settings-grid">
                <!-- Thresholds Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> Thresholds</h3>
                    <div class="input-group">
                        <label for="tiltSideThreshold">Side Tilt Threshold (°)</label>
                        <input type="number" id="tiltSideThreshold" step="0.1" value="30">
                    </div>
                    <div class="input-group">
                        <label for="tiltFbThreshold">Front/Back Tilt Threshold (°)</label>
                        <input type="number" id="tiltFbThreshold" step="0.1" value="9">
                    </div>
                    <div class="input-group">
                        <label for="distThreshold">Distance Threshold (cm)</label>
                        <input type="number" id="distThreshold" step="0.1" value="120">
                    </div>
                    <div class="input-group">
                        <label for="lightThreshold">Light Threshold (lux)</label>
                        <input type="number" id="lightThreshold" step="0.1" value="1000">
                    </div>
                </div>

                <!-- EMA Alpha Values Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-chart-line"></i> EMA Sensitivity</h3>
                    <div class="input-group">
                        <label for="emaAlphaLight">Light EMA Alpha (0-1)</label>
                        <input type="number" id="emaAlphaLight" step="0.01" min="0" max="1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="emaAlphaLidar">Lidar EMA Alpha (0-1)</label>
                        <input type="number" id="emaAlphaLidar" step="0.01" min="0" max="1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="emaAlphaMpu">MPU EMA Alpha (0-1)</label>
                        <input type="number" id="emaAlphaMpu" step="0.01" min="0" max="1" value="0">
                    </div>
                </div>

                <!-- Sensor Adjustments Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-sliders-h"></i> Sensor Adjustments</h3>
                    <div class="input-group">
                        <label for="lightAdjustment">Light Adjustment</label>
                        <input type="number" id="lightAdjustment" step="0.1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="lidarAdjustment">Lidar Adjustment</label>
                        <input type="number" id="lidarAdjustment" step="0.1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="accelXAdjustment">Accel X Adjustment</label>
                        <input type="number" id="accelXAdjustment" step="0.1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="tiltSideAdjustment">Tilt Side Adjustment</label>
                        <input type="number" id="tiltSideAdjustment" step="0.1" value="0">
                    </div>
                    <div class="input-group">
                        <label for="tiltFbAdjustment">Tilt FB Adjustment</label>
                        <input type="number" id="tiltFbAdjustment" step="0.1" value="0">
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="loadParametersFromFirebase()">Load Current</button>
                <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveParametersToFirebase()">Save Settings</button>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDg9Le8N-x1v30_ArHJWQGoEIoNdUXStjI",
            authDomain: "wheelio-0o.firebaseapp.com",
            databaseURL: "https://wheelio-0o-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wheelio-0o",
        };

        // --- 2. INITIALIZE FIREBASE & GET REFERENCES ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Element References
        const lastUpdatedEl = document.getElementById('last-updated');
        
        const buzzerStatus = document.getElementById('buzzer-status');
        const warningLightStatus = document.getElementById('warning-light-status');
        const fogLightStatus = document.getElementById('fog-light-status');
        
        const rollBicycle = document.getElementById('roll-bicycle');
        const rollValue = document.getElementById('roll-value');
        const pitchBicycle = document.getElementById('pitch-bicycle');
        const pitchValue = document.getElementById('pitch-value');

        const lidarValue = document.getElementById('lidar-value');
        const lightValue = document.getElementById('light-value');
        const accelValue = document.getElementById('accel-value');
        
        const warningCard = document.getElementById('warning-card');
        const warningMessage = document.getElementById('warning-message');


        // --- 3. FIREBASE DATA LISTENER ---
        // Reference to the specific node in your database.
        // Expected warning rules from the Wheelio bicycle safety system:
        // - Side tilt > 30°: Buzzer + Warning Light
        // - Front/back tilt > 9°: Buzzer + Warning Light  
        // - Acceleration ≥ 2 m/s²: Buzzer + Warning Light
        // - Lidar ≤ 1.50m: Warning Light only
        // 
        // Automatic features (not warnings):
        // - Light < 1000 lux: Fog Light (visibility aid for bicycle)
        const dataRef = database.ref('sensor_readings_test2');

        // --- SETTINGS MODAL FUNCTIONS ---
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadParametersFromFirebase();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettingsModal();
            }
        }

        function showStatusMessage(message, isSuccess = true) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${isSuccess ? 'status-success' : 'status-error'}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        function loadParametersFromFirebase() {
            const parametersRef = database.ref('parameters');
            
            parametersRef.once('value')
                .then((snapshot) => {
                    const params = snapshot.val() || {};
                    
                    // Load thresholds
                    document.getElementById('tiltSideThreshold').value = params.TILT_SIDE_THRESHOLD || 30;
                    document.getElementById('tiltFbThreshold').value = params.TILT_FB_THRESHOLD || 9;
                    document.getElementById('distThreshold').value = params.DIST_THRESHOLD || 120;
                    document.getElementById('lightThreshold').value = params.LIGHT_THRESHOLD || 1000;
                    
                    // Load EMA alpha values
                    document.getElementById('emaAlphaLight').value = params.EMA_ALPHA_LIGHT || 0;
                    document.getElementById('emaAlphaLidar').value = params.EMA_ALPHA_LIDAR || 0;
                    document.getElementById('emaAlphaMpu').value = params.EMA_ALPHA_MPU || 0;
                    
                    // Load sensor adjustments
                    document.getElementById('lightAdjustment').value = params.LIGHT_ADJUSTMENT || 0;
                    document.getElementById('lidarAdjustment').value = params.LIDAR_ADJUSTMENT || 0;
                    document.getElementById('accelXAdjustment').value = params.ACCEL_X_ADJUSTMENT || 0;
                    document.getElementById('tiltSideAdjustment').value = params.TILT_SIDE_ADJUSTMENT || 0;
                    document.getElementById('tiltFbAdjustment').value = params.TILT_FB_ADJUSTMENT || 0;
                    
                    showStatusMessage('Parameters loaded successfully!');
                })
                .catch((error) => {
                    console.error('Error loading parameters:', error);
                    showStatusMessage('Failed to load parameters: ' + error.message, false);
                });
        }

        function showToast(message, isSuccess = true) {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${isSuccess ? 'success' : 'error'}`;
            toast.innerHTML = `
                <i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;

            // Add to body
            document.body.appendChild(toast);

            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function saveParametersToFirebase() {
            const parameters = {
                // Thresholds
                TILT_SIDE_THRESHOLD: parseFloat(document.getElementById('tiltSideThreshold').value) || 0,
                TILT_FB_THRESHOLD: parseFloat(document.getElementById('tiltFbThreshold').value) || 0,
                DIST_THRESHOLD: parseFloat(document.getElementById('distThreshold').value) || 0,
                LIGHT_THRESHOLD: parseFloat(document.getElementById('lightThreshold').value) || 0,
                
                // EMA Alpha values
                EMA_ALPHA_LIGHT: parseFloat(document.getElementById('emaAlphaLight').value) || 0,
                EMA_ALPHA_LIDAR: parseFloat(document.getElementById('emaAlphaLidar').value) || 0,
                EMA_ALPHA_MPU: parseFloat(document.getElementById('emaAlphaMpu').value) || 0,
                
                // Sensor adjustments
                LIGHT_ADJUSTMENT: parseFloat(document.getElementById('lightAdjustment').value) || 0,
                LIDAR_ADJUSTMENT: parseFloat(document.getElementById('lidarAdjustment').value) || 0,
                ACCEL_X_ADJUSTMENT: parseFloat(document.getElementById('accelXAdjustment').value) || 0,
                TILT_SIDE_ADJUSTMENT: parseFloat(document.getElementById('tiltSideAdjustment').value) || 0,
                TILT_FB_ADJUSTMENT: parseFloat(document.getElementById('tiltFbAdjustment').value) || 0,
                
                // Add timestamp for tracking
                last_updated: Date.now()
            };
            
            const parametersRef = database.ref('parameters');
            
            parametersRef.set(parameters)
                .then(() => {
                    closeSettingsModal();
                    showToast('Settings saved successfully!');
                    console.log('Parameters saved to Firebase:', parameters);
                })
                .catch((error) => {
                    console.error('Error saving parameters:', error);
                    showToast('Failed to save settings: ' + error.message, false);
                });
        }

        // --- MAIN DATA LISTENER ---
        dataRef.on('value', (snapshot) => {
            const rawData = snapshot.val();
            console.log("New data received:", rawData);

            if (rawData) {
                // Extract the latest entry from the nested structure
                // The data comes as an object with unique keys containing the actual sensor data
                const dataEntries = Object.values(rawData);
                
                if (dataEntries.length === 0) {
                    lastUpdatedEl.textContent = "No data entries found...";
                    return;
                }

                // Get the latest entry based on timestamp
                const latestData = dataEntries.reduce((latest, current) => {
                    return (current.timestamp > latest.timestamp) ? current : latest;
                });

                console.log("Latest data entry:", latestData);

                // --- Update UI with latest data ---

                // Update Actuators
                if (latestData.actuators) {
                    buzzerStatus.classList.toggle('active', latestData.actuators.buzzer);
                    warningLightStatus.classList.toggle('active', latestData.actuators.warning_light);
                    fogLightStatus.classList.toggle('active', latestData.actuators.fog_light);
                }

                // Update Tilt (Inclination) Sensors with Bicycle Images
                if (latestData.sensors) {
                    const roll = latestData.sensors.tilt_side;
                    const pitch = latestData.sensors.tilt_fb;

                    if (roll !== undefined && pitch !== undefined) {
                        // Clamp the visual rotation to a reasonable range (-45 to 45 deg) for better visualization
                        const clampedRoll = Math.max(-45, Math.min(45, roll));
                        const clampedPitch = Math.max(-45, Math.min(45, pitch));

                        // Roll bicycle (front view) - tilts left/right for side tilt
                        // 0° = vertical (upright bike), positive = lean right, negative = lean left
                        rollBicycle.style.transform = `rotate(${clampedRoll}deg)`;
                        rollValue.textContent = `${roll.toFixed(2)}°`;
                        
                        // Pitch bicycle (side view) - tilts forward/backward for front/back tilt
                        // 0° = horizontal (level bike), positive = front down, negative = front up
                        pitchBicycle.style.transform = `rotate(${clampedPitch}deg)`;
                        pitchValue.textContent = `${pitch.toFixed(2)}°`;
                    }

                    // Update other sensor values
                    if (latestData.sensors.lidar !== undefined) {
                        // Convert lidar from centimeters to meters
                        const lidarInMeters = latestData.sensors.lidar / 100;
                        lidarValue.innerHTML = `${lidarInMeters.toFixed(2)} <span class="unit">m</span>`;
                    }
                    if (latestData.sensors.light !== undefined) {
                        lightValue.innerHTML = `${Math.round(latestData.sensors.light)} <span class="unit">lux</span>`;
                    }
                    if (latestData.sensors.accel_x !== undefined) {
                        accelValue.innerHTML = `${latestData.sensors.accel_x.toFixed(2)} <span class="unit">m/s²</span>`;
                    }
                }
                
                // Update Warning Message
                if (latestData.warning && latestData.warning.trim() !== "") {
                    warningMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${latestData.warning}`;
                    warningCard.classList.add('has-warning');
                } else {
                    warningMessage.innerHTML = '<i class="fas fa-check-circle"></i> System nominal. All clear.';
                    warningCard.classList.remove('has-warning');
                }

                // Update Timestamp
                if (latestData.timestamp) {
                    const timestamp = new Date(latestData.timestamp);
                    lastUpdatedEl.textContent = `Last Updated: ${timestamp.toLocaleString()}`;
                }

            } else {
                lastUpdatedEl.textContent = "Waiting for data from Firebase...";
            }
        }, (error) => {
            console.error("Firebase connection error:", error);
            lastUpdatedEl.textContent = "Error connecting to Firebase. Check console and config.";
        });
    </script>
</body>
</html>

