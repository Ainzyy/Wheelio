<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheelio Dashboard</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- Basic Setup & Theming --- */
        :root {
            --bg-color: #1a1a2e;
            --card-bg-color: #16213e;
            --text-color: #e0e0e0;
            --primary-color: #0f3460;
            --accent-color: #e94560;
            --active-glow: #52cffe;
            --warning-glow: #e94560;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        /* --- Main Layout --- */
        .dashboard-container {
            width: 100%;
            max-width: 1200px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 .fa-dharmachakra {
            color: var(--active-glow);
            animation: gentle-spin 20s linear infinite;
            font-size: 1.2em;
        }

        @keyframes gentle-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #last-updated {
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- Card Styling --- */
        .card {
            background-color: var(--card-bg-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            margin: 0 0 20px 0;
            text-align: center;
            color: white;
        }

        /* --- Actuator Component Styling --- */
        .actuators-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }

        .actuator-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .actuator-item .icon {
            font-size: 2.5em;
            color: #4a5578;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        .actuator-item.active .icon-buzzer { color: var(--warning-glow); text-shadow: 0 0 15px var(--warning-glow); }
        .actuator-item.active .icon-warning { color: var(--warning-glow); text-shadow: 0 0 15px var(--warning-glow); }
        .actuator-item.active .icon-fog { color: var(--active-glow); text-shadow: 0 0 15px var(--active-glow); }
        
        .actuator-item span {
            font-weight: 500;
        }

        /* --- Sensor Value Component Styling --- */
        .sensor-value {
            font-size: 2.8em;
            font-weight: 700;
            text-align: center;
            margin: auto 0;
            color: white;
        }
        .sensor-value .unit {
            font-size: 0.5em;
            font-weight: 400;
            color: var(--text-color);
        }

        /* --- Inclination (Tilt) Component Styling --- */
        .tilt-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .bicycle-visualizer {
            width: 150px;
            height: 150px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, var(--bg-color) 0%, var(--card-bg-color) 100%);
            position: relative;
            overflow: hidden;
        }

        .bike-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            /* Convert black bike to match our active-glow color (#52cffe) */
            filter: 
                invert(1) /* Invert black to white */
                sepia(1) /* Add sepia for color manipulation */
                saturate(3) /* Increase saturation */
                hue-rotate(190deg) /* Rotate hue to cyan-blue range */
                brightness(1.1) /* Brighten to match our theme */
                contrast(1.3) /* Add contrast for clarity */
                drop-shadow(0 0 15px var(--active-glow)); /* Glowing effect */
            z-index: 2;
            position: relative;
        }

        .reference-line {
            position: absolute;
            background-color: var(--active-glow);
            opacity: 0.6;
            z-index: 1;
        }

        .horizontal-line {
            width: 120px;
            height: 2px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .vertical-line {
            width: 2px;
            height: 120px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Tilt Container for External Labels */
        .tilt-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
        }

        /* Direction Labels */
        .direction-label {
            font-size: 0.8em;
            font-weight: bold;
            color: var(--active-glow);
            opacity: 0.8;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
        }

        /* Roll (Side Tilt) Labels - Left and Right of circle */
        .left-label, .right-label {
            display: flex;
            align-items: center;
            min-width: 35px;
            justify-content: center;
        }

        /* Pitch (Front/Back Tilt) Labels - Left (BACK) and Right (FRONT) of circle */
        .back-label, .front-label {
            display: flex;
            align-items: center;
            min-width: 40px;
            justify-content: center;
        }

        .tilt-value {
            font-size: 1.5em;
            font-weight: 600;
        }

        /* Legacy tilt visualizer styles (keeping for compatibility) */
        .tilt-visualizer {
            width: 150px;
            height: 150px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, var(--bg-color) 0%, var(--card-bg-color) 100%);
        }

        .tilt-indicator {
            width: 90%;
            height: 5px;
            background-color: var(--active-glow);
            border-radius: 5px;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 10px var(--active-glow);
        }

        /* --- Warning Message Styling --- */
        #warning-card {
            grid-column: 1 / -1; /* Span full width */
            border-color: transparent;
            background-color: transparent;
            text-align: center;
            min-height: 50px;
            justify-content: center;
        }
        
        #warning-card.has-warning {
             background-color: #5d1c28;
             border-color: var(--accent-color);
        }

        #warning-message {
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        #warning-message i {
            margin-right: 10px;
        }

        #warning-message .fa-check-circle {
            color: #52cffe;
        }

        #warning-message .fa-exclamation-triangle {
            color: var(--accent-color);
        }

        /* --- Demo Button Styling --- */
        .demo-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: var(--active-glow);
            border: 1px solid var(--active-glow);
            border-radius: 25px;
            padding: 8px 16px;
            text-decoration: none;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .demo-button:hover {
            background-color: var(--active-glow);
            color: var(--bg-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 207, 254, 0.3);
        }

        .demo-button i {
            font-size: 0.9em;
        }

    </style>
</head>
<body>

    <!-- Demo Button -->
    <a href="Test-Dashboard.html" class="demo-button" title="Open Test Dashboard for Demo">
        <i class="fas fa-play-circle"></i>
        Demo
    </a>

    <div class="dashboard-container">
        <header>
            <h1><i class="fas fa-dharmachakra"></i> Wheelio Dashboard</h1>
            <p id="last-updated">Connecting to Firebase...</p>
        </header>

        <div class="grid-container">
            <!-- Actuators Card -->
            <div class="card">
                <h3 class="card-title">Actuator Status</h3>
                <div class="actuators-container">
                    <div id="buzzer-status" class="actuator-item">
                        <i class="fas fa-bell icon icon-buzzer"></i>
                        <span>Buzzer</span>
                    </div>
                    <div id="warning-light-status" class="actuator-item">
                        <i class="fas fa-lightbulb icon icon-warning"></i>
                        <span>Warning Light</span>
                    </div>
                    <div id="fog-light-status" class="actuator-item">
                        <i class="fas fa-cloud-sun icon icon-fog"></i>
                        <span>Fog Light</span>
                    </div>
                </div>
            </div>

            <!-- Side to Side Tilt (Roll) -->
            <div class="card">
                <h3 class="card-title">Side Tilt (Roll)</h3>
                <div class="tilt-display">
                    <div class="tilt-container">
                        <div class="direction-label left-label">LEFT</div>
                        <div class="bicycle-visualizer">
                            <div class="reference-line vertical-line"></div>
                            <img id="roll-bicycle" src="assets/images/bike-front.png" alt="Bike Front View" class="bike-image">
                        </div>
                        <div class="direction-label right-label">RIGHT</div>
                    </div>
                    <div id="roll-value" class="tilt-value">0.00°</div>
                </div>
            </div>

            <!-- Front/Back Tilt (Pitch) -->
            <div class="card">
                <h3 class="card-title">Front/Back Tilt (Pitch)</h3>
                <div class="tilt-display">
                    <div class="tilt-container">
                        <div class="direction-label back-label">BACK</div>
                        <div class="bicycle-visualizer">
                            <div class="reference-line horizontal-line"></div>
                            <img id="pitch-bicycle" src="assets/images/bike-side.png" alt="Bike Side View" class="bike-image">
                        </div>
                        <div class="direction-label front-label">FRONT</div>
                    </div>
                    <div id="pitch-value" class="tilt-value">0.00°</div>
                </div>
            </div>
            
            <!-- Other Sensors -->
            <div class="card">
                <h3 class="card-title">Lidar Distance</h3>
                <p id="lidar-value" class="sensor-value">0.00 <span class="unit">m</span></p>
            </div>

            <div class="card">
                <h3 class="card-title">Ambient Light</h3>
                <p id="light-value" class="sensor-value">0 <span class="unit">lux</span></p>
            </div>

            <div class="card">
                <h3 class="card-title">Acceleration (X)</h3>
                <p id="accel-value" class="sensor-value">0.00 <span class="unit">m/s²</span></p>
            </div>
            
            <!-- Warning Message -->
            <div id="warning-card" class="card">
                <p id="warning-message"><i class="fas fa-check-circle"></i> System nominal.</p>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDg9Le8N-x1v30_ArHJWQGoEIoNdUXStjI",
            authDomain: "wheelio-0o.firebaseapp.com",
            databaseURL: "https://wheelio-0o-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wheelio-0o",
        };

        // --- 2. INITIALIZE FIREBASE & GET REFERENCES ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Element References
        const lastUpdatedEl = document.getElementById('last-updated');
        
        const buzzerStatus = document.getElementById('buzzer-status');
        const warningLightStatus = document.getElementById('warning-light-status');
        const fogLightStatus = document.getElementById('fog-light-status');
        
        const rollBicycle = document.getElementById('roll-bicycle');
        const rollValue = document.getElementById('roll-value');
        const pitchBicycle = document.getElementById('pitch-bicycle');
        const pitchValue = document.getElementById('pitch-value');

        const lidarValue = document.getElementById('lidar-value');
        const lightValue = document.getElementById('light-value');
        const accelValue = document.getElementById('accel-value');
        
        const warningCard = document.getElementById('warning-card');
        const warningMessage = document.getElementById('warning-message');


        // --- 3. FIREBASE DATA LISTENER ---
        // Reference to the specific node in your database.
        // Expected warning rules from the Wheelio bicycle safety system:
        // - Side tilt > 30°: Buzzer + Warning Light
        // - Front/back tilt > 9°: Buzzer + Warning Light  
        // - Acceleration ≥ 2 m/s²: Buzzer + Warning Light
        // - Lidar ≤ 1.50m: Warning Light only
        // 
        // Automatic features (not warnings):
        // - Light < 1000 lux: Fog Light (visibility aid for bicycle)
        const dataRef = database.ref('sensor_readings_test2');

        dataRef.on('value', (snapshot) => {
            const rawData = snapshot.val();
            console.log("New data received:", rawData);

            if (rawData) {
                // Extract the latest entry from the nested structure
                // The data comes as an object with unique keys containing the actual sensor data
                const dataEntries = Object.values(rawData);
                
                if (dataEntries.length === 0) {
                    lastUpdatedEl.textContent = "No data entries found...";
                    return;
                }

                // Get the latest entry based on timestamp
                const latestData = dataEntries.reduce((latest, current) => {
                    return (current.timestamp > latest.timestamp) ? current : latest;
                });

                console.log("Latest data entry:", latestData);

                // --- Update UI with latest data ---

                // Update Actuators
                if (latestData.actuators) {
                    buzzerStatus.classList.toggle('active', latestData.actuators.buzzer);
                    warningLightStatus.classList.toggle('active', latestData.actuators.warning_light);
                    fogLightStatus.classList.toggle('active', latestData.actuators.fog_light);
                }

                // Update Tilt (Inclination) Sensors with Bicycle Images
                if (latestData.sensors) {
                    const roll = latestData.sensors.tilt_side;
                    const pitch = latestData.sensors.tilt_fb;

                    if (roll !== undefined && pitch !== undefined) {
                        // Clamp the visual rotation to a reasonable range (-45 to 45 deg) for better visualization
                        const clampedRoll = Math.max(-45, Math.min(45, roll));
                        const clampedPitch = Math.max(-45, Math.min(45, pitch));

                        // Roll bicycle (front view) - tilts left/right for side tilt
                        // 0° = vertical (upright bike), positive = lean right, negative = lean left
                        rollBicycle.style.transform = `rotate(${clampedRoll}deg)`;
                        rollValue.textContent = `${roll.toFixed(2)}°`;
                        
                        // Pitch bicycle (side view) - tilts forward/backward for front/back tilt
                        // 0° = horizontal (level bike), positive = front down, negative = front up
                        pitchBicycle.style.transform = `rotate(${clampedPitch}deg)`;
                        pitchValue.textContent = `${pitch.toFixed(2)}°`;
                    }

                    // Update other sensor values
                    if (latestData.sensors.lidar !== undefined) {
                        lidarValue.innerHTML = `${latestData.sensors.lidar.toFixed(2)} <span class="unit">m</span>`;
                    }
                    if (latestData.sensors.light !== undefined) {
                        lightValue.innerHTML = `${Math.round(latestData.sensors.light)} <span class="unit">lux</span>`;
                    }
                    if (latestData.sensors.accel_x !== undefined) {
                        accelValue.innerHTML = `${latestData.sensors.accel_x.toFixed(2)} <span class="unit">m/s²</span>`;
                    }
                }
                
                // Update Warning Message
                if (latestData.warning && latestData.warning.trim() !== "") {
                    warningMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${latestData.warning}`;
                    warningCard.classList.add('has-warning');
                } else {
                    warningMessage.innerHTML = '<i class="fas fa-check-circle"></i> System nominal. All clear.';
                    warningCard.classList.remove('has-warning');
                }

                // Update Timestamp
                if (latestData.timestamp) {
                    const timestamp = new Date(latestData.timestamp);
                    lastUpdatedEl.textContent = `Last Updated: ${timestamp.toLocaleString()}`;
                }

            } else {
                lastUpdatedEl.textContent = "Waiting for data from Firebase...";
            }
        }, (error) => {
            console.error("Firebase connection error:", error);
            lastUpdatedEl.textContent = "Error connecting to Firebase. Check console and config.";
        });
    </script>
</body>
</html>

